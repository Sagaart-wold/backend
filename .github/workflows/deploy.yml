name: sagaart-deploy

on:
  push:
    branches:
      - add/git-actions

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repositories
        run: |
          # Клонируем docker-wrapper
          git clone https://github.com/Sagaart-wold/docker-wrapper.git
          cd docker-wrapper
          mv .env.example .env
          # клонируем фронт и бек
          git clone https://github.com/Sagaart-wold/backend.git -b develop backend
          git clone https://github.com/Sagaart-wold/frontend.git -b develop frontend 

      - name: Run Docker Compose
        working-directory: docker-wrapper
        run: docker compose up -d

      - name: Tear down Docker Compose
        if: always()
        working-directory: docker-wrapper
        run: docker compose down --volumes --rmi all

  deploy:
    runs-on: ubuntu-latest
    needs:
      # Дождёмся успешного билда
      - build
    steps:
      - name: Executing remote ssh commands to deploy
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.KEY }}
          port: ${{ secrets.PORT }}
          script: |
            # Обновляем репозитории
            cd docker-wrapper
            git pull
            cd backend
            git pull
            cd ../frontend
            git pull
            cd ..
            # Перезапускаем докер
            sudo docker compose down
            sudo docker compose up -d

      - name: send messsage
        if: always()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: Деплой ${{ steps.deploy.conclusion }}!